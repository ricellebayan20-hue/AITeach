<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartTasks | Quarterly, Monthly & Weekly Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; margin: 0; padding: 0; }
        .sidebar { width: 240px; background-color: #ffffff; border-right: 1px solid #e2e8f0; height: 100vh; flex-shrink: 0; }
        .sidebar-item { padding: 12px 24px; display: flex; align-items: center; gap: 12px; color: #64748b; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .sidebar-item:hover { color: #2563eb; background-color: #f8fafc; }
        .sidebar-item.active { background-color: #2563eb !important; color: #ffffff !important; border-radius: 8px; margin: 0 12px 4px 12px; padding: 12px 16px; }
        .glass-card { background: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #f1f5f9; }
        .task-table th { text-align: left; padding: 12px 16px; color: #94a3b8; font-size: 11px; font-weight: 700; border-bottom: 1px solid #f1f5f9; text-transform: uppercase; }
        .task-table td { padding: 14px 16px; border-bottom: 1px solid #f8fafc; font-size: 14px; color: #334155; }
        #login-screen { position: fixed; inset: 0; z-index: 1000; background-color: #f8fafc; display: flex; align-items: center; justify-content: center; }
        .view-section { display: none; width: 100%; }
        .view-section.active { display: block !important; }
        #app-container { display: none; width: 100vw; height: 100vh; }
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .quarter-pill { cursor: pointer; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; transition: all 0.2s; border: 1px solid #e2e8f0; color: #64748b; }
        .quarter-pill.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        
        .hidden-auth { display: none; }

        .file-btn { 
            transition: all 0.2s;
            border: 1px dashed #cbd5e1;
        }
        .file-btn:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .file-btn.attached {
            border-style: solid;
            border-color: #10b981;
            background-color: #ecfdf5;
            color: #059669;
        }

        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 480px; border-radius: 16px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <!-- Splash Loading -->
    <div id="loading-overlay">
        <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center mb-4 animate-bounce">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
        </div>
        <h2 class="text-xl font-bold text-slate-800">SmartTasks</h2>
    </div>

    <!-- Auth System -->
    <div id="login-screen">
        <div class="relative w-full max-w-md p-8 bg-white rounded-2xl shadow-2xl border border-slate-200 min-h-[500px] flex flex-col justify-center">
            <div id="login-container">
                <div class="flex flex-col items-center mb-8">
                    <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center mb-3">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                    </div>
                    <span class="text-2xl font-bold text-slate-800">SmartTasks</span>
                    <p class="text-slate-400 text-sm mt-1 text-center">Sign in to your account</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" required placeholder="Email (e.g., juan@deped.gov.ph)" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="password" id="login-password" required placeholder="Password" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-100 transition-all">Sign In</button>
                    <p class="text-center text-sm text-slate-500 mt-4">
                        Don't have an account? <a href="#" onclick="toggleAuth('signup')" class="text-blue-600 font-bold hover:underline">Create Account</a>
                    </p>
                    <button type="button" id="bypass-login" class="w-full text-xs text-slate-400 hover:text-slate-600 underline mt-2">Bypass for Testing</button>
                </form>
            </div>

            <div id="signup-container" class="hidden-auth">
                <div class="flex flex-col items-center mb-8">
                    <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center mb-3">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                    </div>
                    <span class="text-2xl font-bold text-slate-800">Create Account</span>
                    <p class="text-slate-400 text-sm mt-1 text-center">Join the SmartTasks workspace</p>
                </div>
                <form id="signup-form" class="space-y-4">
                    <input type="text" id="signup-name" required placeholder="Full Name (e.g., Juan Dela Cruz)" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none">
                    <input type="email" id="signup-email" required placeholder="Email Address" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none">
                    <input type="password" id="signup-password" required placeholder="Create Password" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none">
                    <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-100 transition-all">Register Now</button>
                    <p class="text-center text-sm text-slate-500 mt-4">
                        Already have an account? <a href="#" onclick="toggleAuth('login')" class="text-emerald-600 font-bold hover:underline">Sign In Instead</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal -->
    <div id="task-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-slate-800 mb-2">New Ancillary Task</h3>
            <p class="text-slate-500 text-xs mb-6">Create a requirement for teachers to submit.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Task Title</label>
                    <input type="text" id="modal-task-title" placeholder="e.g., Annual Action Plan 2024" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Category</label>
                        <select id="modal-task-cat" class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <option>Accomplishment Report</option>
                            <option>Action Plan</option>
                            <option>Community Relations</option>
                            <option>Professional Development</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Frequency</label>
                        <select id="modal-task-freq" class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <option value="schoolyear">School Year</option>
                            <option value="quarter">Per Quarter</option>
                            <option value="month">Per Month</option>
                            <option value="week">Per Week</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Attach Template/Reference</label>
                    <div id="modal-file-dropzone" class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center cursor-pointer hover:border-blue-400 transition-all bg-slate-50">
                        <input type="file" id="modal-task-file" class="hidden" accept=".doc,.docx,.xls,.xlsx,.pdf,.png,.jpg,.jpeg" onchange="updateModalFileName()">
                        <div class="flex flex-col items-center" id="modal-file-status">
                            <svg class="w-8 h-8 text-slate-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <span class="text-xs text-slate-500 font-medium">Click to upload template</span>
                            <span class="text-[10px] text-slate-400 mt-1">Word, Excel, PDF, or Images</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeTaskModal()" class="flex-1 py-2 font-bold text-slate-500 hover:bg-slate-100 rounded-lg transition-all">Cancel</button>
                    <button onclick="saveNewTask()" class="flex-1 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Create Requirement</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App UI -->
    <div id="app-container" class="flex w-full h-full">
        <aside class="sidebar flex flex-col py-6">
            <div class="px-6 mb-10 flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                </div>
                <span class="text-xl font-bold text-slate-800">SmartTasks</span>
            </div>
            <nav class="flex-grow">
                <div class="sidebar-item active" data-target="dash">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg> Dashboard
                </div>
                <div class="sidebar-item" data-target="account">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> My Workspace
                </div>
            </nav>
        </aside>

        <main class="flex-grow p-8 overflow-y-auto bg-[#f1f5f9]">
            <!-- Dashboard View -->
            <div id="view-dash" class="view-section active">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800">School Dashboard</h1>
                        <p class="text-slate-500 mt-1">Monitoring ancillary submissions by period</p>
                    </div>
                    <div class="flex gap-2 bg-white p-1 rounded-full shadow-sm border border-slate-200">
                        <div class="quarter-pill active" onclick="setGlobalQuarter(1)">Q1</div>
                        <div class="quarter-pill" onclick="setGlobalQuarter(2)">Q2</div>
                        <div class="quarter-pill" onclick="setGlobalQuarter(3)">Q3</div>
                        <div class="quarter-pill" onclick="setGlobalQuarter(4)">Q4</div>
                        <div class="quarter-pill" onclick="setGlobalQuarter('SY')">SY</div>
                    </div>
                </div>

                <div class="grid grid-cols-12 gap-6">
                    <div class="col-span-12 lg:col-span-8 glass-card overflow-hidden bg-white">
                        <div class="px-6 py-5 border-b border-slate-50 flex justify-between items-center">
                            <h2 class="font-bold text-slate-700" id="dash-quarter-title">Quarter 1 Submissions</h2>
                            <span class="text-[10px] bg-blue-100 px-2 py-1 rounded text-blue-700 font-bold uppercase" id="quarter-count">0 Documents</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full task-table">
                                <thead>
                                    <tr><th>Task Description</th><th class="text-right">Assignee / Date</th></tr>
                                </thead>
                                <tbody id="dashboard-tbody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
                        <div class="glass-card p-6 bg-white">
                            <h2 class="font-bold text-slate-700 mb-4 text-center text-sm">Submission Status</h2>
                            <div class="h-[220px]">
                                <canvas id="donutChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workspace View -->
            <div id="view-account" class="view-section">
                <div class="max-w-4xl mx-auto space-y-6 mt-6">
                    <div class="flex justify-between items-end">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Teacher Workspace</h2>
                            <p class="text-slate-500 text-sm">User: <span id="acc-name-text" class="font-bold text-blue-600">Juan Dela Cruz</span></p>
                        </div>
                        <div class="flex flex-col items-end gap-3">
                            <button onclick="openTaskModal()" class="flex items-center gap-2 bg-blue-600 text-white text-xs font-bold px-4 py-2.5 rounded-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2.5"></path></svg>
                                Add New Requirement
                            </button>
                            <div class="flex flex-col items-end">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Target Period</label>
                                <select id="user-quarter-select" onchange="renderUserTasks()" class="bg-white border border-slate-200 rounded-lg px-3 py-1.5 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="1">Quarter 1 (Jan-Mar)</option>
                                    <option value="2">Quarter 2 (Apr-Jun)</option>
                                    <option value="3">Quarter 3 (Jul-Sep)</option>
                                    <option value="4">Quarter 4 (Oct-Dec)</option>
                                    <option value="SY">School Year Requirement</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card bg-white overflow-hidden">
                        <div class="px-6 py-5 border-b border-slate-50 flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-slate-700">Pending Submissions</h2>
                                <p class="text-[11px] text-slate-400">Attach files to fulfill your ancillary tasks</p>
                            </div>
                            <button id="logout-btn" class="text-xs font-bold text-rose-500 hover:text-rose-700">Logout</button>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4" id="user-tasks-container">
                                <!-- Tasks -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let taskTemplates = [
            { id: 1, title: "Coordinate PTA Meeting", cat: "Community", freq: "quarter" },
            { id: 2, title: "Submission of Nutritional Status", cat: "Health & Nutrition", freq: "quarter" },
            { id: 3, title: "Submission of DLL", cat: "Instructional", freq: "week" },
            { id: 4, title: "Submission of DPDS Partnership", cat: "Social", freq: "month" },
            { id: 5, title: "Submission of MPS", cat: "Academic", freq: "quarter" },
            { id: 6, title: "Submission of SMEA", cat: "Governance", freq: "quarter" },
            { id: 7, title: "Submission of Monthly Learners Attendance (SF2)", cat: "Learner Data", freq: "month_full" },
            { id: 8, title: "Annual Action Plan (SY 2024-2025)", cat: "Action Plan", freq: "schoolyear" }
        ];

        const fullMonths = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthsPerQuarter = { "1": ["January", "February", "March"], "2": ["April", "May", "June"], "3": ["July", "August", "September"], "4": ["October", "November", "December"] };

        let users = [{ email: "juan.delacruz@deped.gov.ph", password: "password", name: "Juan Dela Cruz" }];
        let submissions = []; 
        let globalDashboardQuarter = 1;
        let currentUserName = "";

        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const viewSections = document.querySelectorAll('.view-section');

            setTimeout(() => loadingOverlay.style.display = 'none', 800);

            document.getElementById('modal-file-dropzone').onclick = () => document.getElementById('modal-task-file').click();

            document.getElementById('login-form').onsubmit = (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                const user = users.find(u => u.email === email && u.password === pass);
                if (user) loginSuccess(user.name);
                else alert("Invalid credentials.");
            };

            document.getElementById('signup-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const pass = document.getElementById('signup-password').value;
                users.push({ name, email, password: pass });
                toggleAuth('login');
            };

            document.getElementById('bypass-login').onclick = () => loginSuccess("Juan Dela Cruz");
            document.getElementById('logout-btn').onclick = () => location.reload();

            sidebarItems.forEach(item => {
                item.onclick = () => {
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const target = item.dataset.target;
                    viewSections.forEach(v => v.classList.toggle('active', v.id === `view-${target}`));
                    if (target === 'dash') renderDashboard();
                };
            });
        });

        // Task Creation Modal Logic
        window.openTaskModal = () => {
            document.getElementById('task-modal').style.display = 'flex';
        };

        window.closeTaskModal = () => {
            document.getElementById('task-modal').style.display = 'none';
            document.getElementById('modal-task-title').value = "";
            document.getElementById('modal-task-file').value = "";
            document.getElementById('modal-file-status').innerHTML = `<svg class="w-8 h-8 text-slate-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg><span class="text-xs text-slate-500 font-medium">Click to upload template</span><span class="text-[10px] text-slate-400 mt-1">Word, Excel, PDF, or Images</span>`;
        };

        window.updateModalFileName = () => {
            const input = document.getElementById('modal-task-file');
            const status = document.getElementById('modal-file-status');
            if (input.files && input.files[0]) {
                status.innerHTML = `<svg class="w-8 h-8 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="text-xs text-blue-600 font-bold">${input.files[0].name}</span><span class="text-[10px] text-slate-400 mt-1">Ready to create</span>`;
            }
        };

        window.saveNewTask = () => {
            const title = document.getElementById('modal-task-title').value;
            const cat = document.getElementById('modal-task-cat').value;
            const freq = document.getElementById('modal-task-freq').value;
            const fileInput = document.getElementById('modal-task-file');

            if (!title) return alert("Task title is required.");

            taskTemplates.push({
                id: Date.now(),
                title: title,
                cat: cat,
                freq: freq,
                hasTemplate: fileInput.files.length > 0
            });

            closeTaskModal();
            renderUserTasks();
        };

        function loginSuccess(name) {
            currentUserName = name;
            document.getElementById('acc-name-text').innerText = name;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            renderDashboard();
            renderUserTasks();
            initCharts();
        }

        window.toggleAuth = (view) => {
            document.getElementById('login-container').classList.toggle('hidden-auth', view === 'signup');
            document.getElementById('signup-container').classList.toggle('hidden-auth', view === 'login');
        };

        function setGlobalQuarter(q) {
            globalDashboardQuarter = q;
            document.querySelectorAll('.quarter-pill').forEach(p => {
                p.classList.toggle('active', p.innerText === (q === 'SY' ? 'SY' : 'Q' + q));
            });
            renderDashboard();
        }

        function renderDashboard() {
            const tbody = document.getElementById('dashboard-tbody');
            const title = document.getElementById('dash-quarter-title');
            const count = document.getElementById('quarter-count');
            
            const filtered = submissions.filter(s => s.quarter == globalDashboardQuarter);
            title.innerText = globalDashboardQuarter === 'SY' ? "Full School Year Submissions" : `Quarter ${globalDashboardQuarter} Submissions`;
            count.innerText = `${filtered.length} Document${filtered.length === 1 ? '' : 's'}`;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2" class="text-center py-12 text-slate-400 italic text-sm">No submissions found for this period</td></tr>`;
            } else {
                tbody.innerHTML = filtered.map(s => `
                    <tr>
                        <td class="font-medium">
                            ${s.title}
                            ${s.week ? `<span class="ml-2 text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold">Week ${s.week}</span>` : ''}
                            ${s.month ? `<span class="ml-2 text-[10px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-bold">${s.month}</span>` : ''}
                            <div class="text-[10px] text-slate-400 font-normal mt-0.5">Format: ${s.fileType}</div>
                        </td>
                        <td class="text-right">
                            <div class="text-xs font-bold text-blue-600">${s.userName}</div>
                            <div class="text-[9px] text-slate-400 mt-1 uppercase">${s.timestamp}</div>
                        </td>
                    </tr>
                `).join('');
            }
            initCharts();
        }

        function renderUserTasks() {
            const container = document.getElementById('user-tasks-container');
            const selectedQ = document.getElementById('user-quarter-select').value;
            
            container.innerHTML = taskTemplates.map(task => {
                // Determine if task should show based on frequency vs selected filter
                if (selectedQ === 'SY' && task.freq !== 'schoolyear') return '';
                if (selectedQ !== 'SY' && task.freq === 'schoolyear') return '';

                if (task.freq === "quarter" || task.freq === "schoolyear") {
                    const isDone = submissions.some(s => s.id === task.id && s.quarter == selectedQ && s.userName === currentUserName);
                    if (isDone) {
                        return `<div class="flex items-center p-4 rounded-xl border border-emerald-100 bg-emerald-50/50">
                                <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center mr-4"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M5 13l4 4L19 7"></path></svg></div>
                                <div class="flex-grow"><p class="text-sm font-semibold text-slate-800">${task.title}</p><span class="text-[10px] text-emerald-600 font-bold uppercase tracking-wider">Submitted for ${selectedQ === 'SY' ? 'School Year' : 'Q'+selectedQ}</span></div>
                            </div>`;
                    }
                }

                return `<div class="flex flex-col p-4 rounded-xl border border-slate-100 bg-white gap-4 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="text-sm font-semibold text-slate-700">${task.title}</p>
                                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${task.cat} â€¢ ${task.freq.toUpperCase()}</span>
                                ${task.hasTemplate ? `<div class="mt-1 flex items-center gap-1 text-[10px] text-blue-600 font-medium"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>Template Available</div>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                ${task.freq === "week" ? `<select id="week-select-${task.id}" class="text-xs font-bold bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none text-blue-700">${Array.from({length: 10}, (_, i) => `<option value="${i+1}">Week ${i+1}</option>`).join('')}</select>` : ''}
                                ${task.freq === "month" ? `<select id="month-select-${task.id}" class="text-xs font-bold bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none text-emerald-700">${monthsPerQuarter[selectedQ].map(m => `<option value="${m}">${m}</option>`).join('')}</select>` : ''}
                                ${task.freq === "month_full" ? `<select id="month-select-${task.id}" class="text-xs font-bold bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none text-rose-600">${fullMonths.map(m => `<option value="${m}">${m}</option>`).join('')}</select>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 pt-2 border-t border-slate-50">
                            <div class="flex flex-wrap gap-2 items-center">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Format:</span>
                                <select id="file-type-${task.id}" onchange="resetAttachment(${task.id})" class="text-[11px] font-semibold border border-slate-200 rounded-lg px-2 py-1 outline-none focus:ring-1 focus:ring-blue-500 bg-slate-50">
                                    <option value="Document">Word (.docx)</option>
                                    <option value="Excel">Excel (.xlsx)</option>
                                    <option value="PDF">PDF (.pdf)</option>
                                    <option value="Image">Image (JPG/PNG)</option>
                                </select>
                                <label class="file-btn flex items-center gap-2 text-[11px] font-bold text-slate-500 bg-slate-50 px-3 py-1.5 rounded-lg cursor-pointer" id="label-container-${task.id}">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.414a4 4 0 00-5.656-5.656l-6.415 6.415a6 6 0 108.486 8.486L19 14"></path></svg>
                                    <span id="label-${task.id}">Attach File</span>
                                    <input type="file" class="hidden" id="input-${task.id}" onchange="enableSubmit(${task.id})">
                                </label>
                            </div>
                            <button onclick="submitTask(${task.id}, '${task.title}', '${task.cat}', '${task.freq}')" id="btn-${task.id}" class="px-6 py-2 bg-slate-200 text-slate-400 text-xs font-bold rounded-lg transition-all" disabled>Submit</button>
                        </div>
                    </div>`;
            }).join('');
        }

        window.resetAttachment = (id) => {
            const btn = document.getElementById(`btn-${id}`);
            const label = document.getElementById(`label-${id}`);
            const container = document.getElementById(`label-container-${id}`);
            const input = document.getElementById(`input-${id}`);
            input.value = "";
            label.innerText = "Attach File";
            container.classList.remove('attached');
            btn.disabled = true;
            btn.className = "px-6 py-2 bg-slate-200 text-slate-400 text-xs font-bold rounded-lg transition-all";
        };

        window.enableSubmit = (id) => {
            const btn = document.getElementById(`btn-${id}`);
            const label = document.getElementById(`label-${id}`);
            const container = document.getElementById(`label-container-${id}`);
            label.innerText = "File Selected"; 
            container.classList.add('attached');
            btn.disabled = false; 
            btn.className = "px-6 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition-all";
        };

        window.submitTask = (id, title, cat, freq) => {
            const quarter = document.getElementById('user-quarter-select').value;
            const week = freq === 'week' ? document.getElementById(`week-select-${id}`).value : null;
            const month = (freq === 'month' || freq === 'month_full') ? document.getElementById(`month-select-${id}`).value : null;
            const fileType = document.getElementById(`file-type-${id}`).value;
            
            const now = new Date();
            const timestamp = now.toLocaleDateString() + " " + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            submissions.unshift({ id, title, cat, quarter, week, month, fileType, userName: currentUserName, timestamp });
            
            renderUserTasks();
            initCharts();
        };

        function initCharts() {
            const ctx = document.getElementById('donutChart')?.getContext('2d');
            if (!ctx) return;
            if (window.myChart) window.myChart.destroy();
            const qCounts = [1, 2, 3, 4, 'SY'].map(q => submissions.filter(s => s.quarter == q).length);
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4', 'SY'],
                    datasets: [{
                        data: qCounts.some(c => c > 0) ? qCounts : [1, 1, 1, 1, 1], 
                        backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'],
                        borderWidth: 0, spacing: 5
                    }]
                },
                options: { cutout: '70%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 10 } } } } }
            });
        }
    </script>
</body>
</html>